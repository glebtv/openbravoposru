Данная статья является переводом и адаптацией статьи [Pentaho Data Integration (Kettle) Tutorial](http://wiki.pentaho.com/display/EAI/Pentaho+Data+Integration+(Kettle)+Tutorial), [María Carina Roldán](mailto:maria.carina.roldan@gmail.com).

Данный материал распространяется по лицензии [Creative Commons Attribution-Noncommercial-Share Alike 3.0 Unported License](http://creativecommons.org/licenses/by-nc-sa/3.0/).

# Вступление #

Система **Pentaho Data Integration** (PDI, также известная как _Kettle_) это компонент комплекса Pentaho отвечающий за процесс Извлечения, Преобразования и Выгрузки данных (ETL). Несмотря на то, что использовать системы ETL предполагается в рамках комплекса хранения данных, средства PDI:Kettle могут быть применены и для других целей:
  * Обмена данными между приложениями или базами данных
  * Экспорта данных из таблиц баз данных в файлы
  * Загрузки массивов данных в базы данных
  * Обработки данных
  * Интеграции в приложения

Использовать PDI:Kettle достаточно просто. Весь процесс разработки в PDI:Kettle ведётся в визуальной форме без написания кода для выполнения необходимых задач, что даёт основание говорить о PDI:Kettle, как о _системе ориентированной на работу с метаданными_.

Система PDI:Kettle может быть использована как самостоятельное приложение или как элемент комплекса Pentaho Suite. Данная система является наиболее популярной среди систем ETL с открытым исходным кодом. В PDI:Kettle реализована поддержка множества форматов ввода и вывода данных для различных файлов, таблиц, коммерческих и свободных систем организации баз данных. Работа в системе PDI:Kettle открывает огромные возможности для управления данными.

Представленное руководство "Привет, Мир!", это простой и наглядный пример, показывающий удобство работы с PDI:Kettle, и позволяющий получить необходимые навыки для создания более сложных Преобразований (Transformation).

# Установка PDI:Kettle #

Загрузить PDI:Kettle можно с [Sourceforge.net](http://community.pentaho.com/sourceforge/). На момент перевода данного руководства стабильной является версия 3.2.0, для установки необходимо загрузить **pdi-ce-3.2.0-stable.zip**.

> (!) _**Внимание:**_ В [оригинальную статью](http://wiki.pentaho.com/display/EAI/Pentaho+Data+Integration+(Kettle)+Tutorial) при переводе были внесены изменения отражающие особенности работы с версией **PDI:Kettle CE 3.2.0**. Для других версий возможны отличия в интерфейсе и реализованных функциях приложения.

## Требования ##

PDI:Kettle работает с Sun Java Runtime Environment (JRE) версии 1.5 (иногда называемой 5.0) или более новой. JRE можно загрузить с http://java.sun.com/.

## Инсталляция ##

Если был загружен .exe файл для Windows, то для установки PDI:Kettle не требуется дополнительного руководства. Для прочих платформ необходимо распаковать файлы из архива в каталог по выбору. Для Unix-подобных операционных систем требуется задать права на запуск скриптов используя команду **chmod**:
```
cd Kettle
chmod \+x \*.sh
```

# Компиляция PDI:Kettle #

Когда была написана данная статья, только вышла новая версия PDI:Kettle 3.2.0, с этого времени официально, т.е. с выпуском релизов, новых версий не выходило. Но в репозитарие исходных кодов проекта Pentaho ставились теги фиксирующие этапы работы над кодом, согласно этих тегов в данный момент (апрель 2010 года) уже есть версия 3.2.5. Ниже приводится инструкция описывающая процесс компиляции PDI:Kettle из исходного кода.

Получить исходный код.
```
svn co svn://source.pentaho.org/svnkettleroot/Kettle/branches/3.2.5/ pdi-kettle-3.2.5
```

Перейти в целевой каталог.
```
cd pdi-kettle-3.2.5
```

Указать в явном виде переменную `JAVA_HOME` в файле автоматической компиляции `autobuild.sh`.
```
JAVA_HOME=/usr/lib/jvm/java-6-sun
```

Разрешить исполнение.
```
chmod \+x autobuild.sh
```

Запустить компиляцию.
```
./autobuild.sh
```

В результате выполнения скрипта `autobuild.sh` будет получен архив `pdi-ce-3.2.5-r.zip` установка из которого уже обновлённой версии PDI:Kettle полностью соответствует описанию в предыдущем разделе.

![![](http://farm5.static.flickr.com/4010/4546959115_ac8ec60539_m.jpg)](http://farm5.static.flickr.com/4010/4546959115_91bbed64a9_o.png)

# Описание Spoon #

Spoon является графической оболочкой для проектирования и проверки выполнения функций PDI:Kettle. Другие приложения входящие в пакет PDI:Kettle выполняются в окне текстового терминала.

## Репозитарий и файлы ##

Spoon предназначена для разработки Заданий (Job) и Преобразований (Transformation). Их хранение в PDI:Kettle осуществляется двумя способами:
  1. В репозитарии
  1. В файле

Если выбран способ хранения в репозитарии, то требуется предварительно его создать. Если выбрано хранение в файле, то Задания хранятся в файлах с расширением **kjb**, а Преобразования в файлах с расширением **ktr**. В данном руководстве рассматривается второй вариант.

## Запуск Spoon ##

Spoon запускается **spoon.bat** в Windows и **spoon.sh** в Unix-подобных операционных системах. После запуска Spoon появляется диалог для подключения к репозитарию. Для целей данного руководства следует нажать кнопку **No Repository**.

После запуска появляется окно приветствия. Можно перейти в меню **Edit** и выбрать **Options...**. В данном окне можно указать параметры для работы в приложении. Если необходимо чтобы изменённые параметры вступили в силу, то требуется перезагрузка Spoon.

# Пример "Здравствуй, Мир!" #

Несмотря на простоту данного примера, в нём представлены основные принципы работы с PDI:Kettle:
  * Работа с инструментарием Spoon
  * Преобразования
  * Шаги и Переходы
  * Предопределенные переменные
  * Предварительный просмотр и выполнение из Spoon
  * Выполнение Преобразований из окна терминала средствами Pan

## Описание ##

Для начала предполагается что существует список фамилий и имён людей в формате CSV файла, и необходимо создать XML файл с приветствием для каждого из них.

Если содержание CVS файла для обработки будет:
```
фамилия,имя
Иванов,Пётр
Семёнова,Любовь
Сидоров,Иван
Васильев,Семён
Семёнов,Дмитрий
Петрова,Анна
```
То готовый XML файл после обработки будет вида:
```
<Rows>
 −<Row>
       <message>Здравствуй, Пётр!</message>
  </Row>
 −<Row>
       <message>Здравствуй, Любовь!</message>
  </Row>
 −<Row>
       <message>Здравствуй, Иван!</message>
  </Row>
 −<Row>
       <message>Здравствуй, Семён!</message>
  </Row>
 −<Row>
       <message>Здравствуй, Дмитрий!</message>
  </Row>
 −<Row>
       <message>Здравствуй, Анна!</message>
  </Row>
</Rows>
```
Целью выполнения данного Преобразования будет создание фраз приветствий из файла.

В целом любое Преобразование состоит из цепочки Шагов (Step) связанных Переходами (Hop). Шаги и Переходы отображают путь перемещения потоков данных. Из чего следует, что Преобразование _ориентированно на поток данных_.

## Подготовка окружения ##

До запуска Преобразования необходимо создать папку **Tutorial** в каталоге инсталляции или любом другом месте. В ней будут хранится все файлы из данного примера. Создать CSV файл с приведённым выше содержанием, и сохранить его в папке **Tutorial** под именем **list.csv**.

## Инструкция по Преобразованию ##

Предлагаемую задачу можно разделить на три этапа:
  1. Создание Преобразования
  1. Разработка каркаса Преобразования из отдельных Шагов и Переходов
  1. Настройка Шагов в соответствии с возлагаемыми на них задачами

### Создание Преобразования ###

  * Нажать **New**, затем выбрать **Transformation**, либо в меню **File** выбрать **New**, а затем **Transformation**. Также доступна комбинация клавиш **Ctrl-N**.
  * Выбрав **Transformation**, нажать **Settings...**.
  * Появившееся окно позволяет задать настройки для Преобразования. Но для данного примера необходимо задать лишь графы Название Преобразования (Transformation name) и Описание (Description), затем нажать **Save**.
  * Сохранить Преобразование в каталоге **Tutorial** под именем **hello**. Будет создан файл **hello.ktr**.

### Разработка каркаса Преобразования из отдельных Шагов и Переходов ###

Каждое Преобразование состоит из множества отдельных _Шагов_. Из всего разнообразия Шагов в первую очередь группируются категории отвечающие за Ввод (Input) и Вывод (Output) данных из/для внешних источников/приёмников. Каждый из Шагов разработан так, чтобы его выполнение обеспечивало результат для определенной функции, например для чтения определённых параметров или нормализации набора введённых данных.

_Переход_ это графическое представление передачи данных между двумя Шагами от источника к приёмнику. Данные передаваемые по средствам Перехода создаются на Шаге Исходящих Данных (Output Data) и предназначены для получения на Шаге Входящих Данных (Input Data). У одного Перехода есть только одно начало и одно окончание, но можно создать несколько Переходов которые будут выходить из одного Шага. Для таких случаев Исходящие Данные могут быть скопированы или распределены между каждым из приёмников. Также данные могут поступать из разных источников на один приёмник. В таких случаях Шаг приёмник должен обладать способностью объединять Входящие Данные из нескольких источников, чтобы создать единый поток Исходящих Данных.

Преобразование должно выполнять следующие функции:
  * Получить данные из файла формата CSV
  * Сформировать приветствия
  * Сохранить приветствия в файле формата XML

Для каждого из этих функций необходимо использовать отдельные Шаги, согласно представленной ниже схемы:

![http://farm3.static.flickr.com/2501/3768250848_72aed15c39_o.png](http://farm3.static.flickr.com/2501/3768250848_72aed15c39_o.png)

В данном примере переходы между Задачами и Шагами определены как один к одному. Это Преобразование с очень простое структурой, но так бывает не всегда.

Для того чтобы начать создавать Преобразование необходимо:
  * В окне приложения Spoon расположена панель **Steps Palette**, в ней раскрыть категорию **Input**.
  * Перетащить иконку **CSV file** в рабочую область справа.
  * Раскрыть категорию **Scripting**.
  * Перетащить иконку **Modified JavaScript Value** в рабочую область.
  * Раскрыть категорию **Output**.
  * Перетащить иконку **XML Output** в рабочую область.

Теперь необходимо организовать связь между **CSV file input** и **Modified Java Script Value** создав Переход:
  * Выбрать иконку первого Шага **CSV file input**.
  * Удерживая на клавиатуре **Shift** переместить курсор на иконку второго Шага **Modified Java Script Value**.
  * Установить связь между **Modified Java Script Value** и **XML Output** повторив действия.

![http://farm3.static.flickr.com/2611/3767450395_b83c1187ec_o.png](http://farm3.static.flickr.com/2611/3767450395_b83c1187ec_o.png)

### Настройка Шагов в соответствии с возлагаемыми на них задачами ###

Для каждого из Шагов предусмотрено окно соответствующих настроек. В окне устанавливаются параметры определяющие функциональные возможности каждого вида Шагов. При этом Наименование Шага (Step Name) не влияет на функциональные возможности Шага, а только обозначает его в Преобразовании. Описание Шага (Step Description) подробно разъясняет цели выполнения Шага, и также не влияет на его функциональные возможности.

#### Настройка Шага Ввод из CSV файла (CSV file input) ####

  * Дважды нажать на Шаг **CSV file input**.
  * Появиться окно настроек для этого Шага. В нём необходимо указать расположение, формат и описать содержания файла для загрузки.
  * Изменить наименование заданное по-умолчанию в графе **Step name** на более соответствующее возлагаемым на данный Шаг задачам. Для данного примера назовём Шаг **Получение списка имён**.
  * В графе **Filename** ввести название и расположение исходного файла.
> _**Примечание:**_ Справа от поля ввода находится символ в виде красного доллара. Это обозначает возможность использования в данном поле переменные. Переменная может быть введена вручную ${name\_of\_the\_variable} или выбрана из списка в окне переменных, для чего следует нажать **Ctrl-Пробел**. В данном окне представлены предопределённые переменные и переменные заданные пользователем, но так как переменные не задавались, то в списке будут лишь предопределённые переменные. Среди них необходимо выбрать:
```
${Internal.Transformation.Filename.Directory}
```
> После переменной ставиться наклонная черта и имя предварительно созданного файла:
```
${Internal.Transformation.Filename.Directory}/list.csv
```
> После запуска значение данной переменной будет получено и выведено в виде пути к каталогу, где храниться Преобразование. Затем будет найден файл **list.csv** в данном каталоге.
  * Нажатие кнопки **Get Fields** добавляет список наименований столбцов и структуры данных из исходного файла. Предполагается что у файла есть заголовок (для этого в графе **Header row present** должна стоять отметка).
> _**Примечание:**_ Кнопка **Get Fields** существует во многих видах Шагов и доступна в окне настроек. Она необходима для загрузки структуры данных из внешнего источника или из предыдущего Шага. При этом всё может быть введено вручную, но эта кнопка сокращает время необходимое для ввода множества полей, при этом предполагается что все они будут использованы в дальнейшей работе.
  * Теперь структура содержит наименование столбцов из файла. Для данного примера это **фамилия** и **имя**:
![![](http://farm4.static.flickr.com/3479/3768250714_8c7feef433_m.jpg)](http://farm4.static.flickr.com/3479/3768250714_7358429c76_o.png)
  * Снять галочку с графы **Lazy conversion?**.
> _**Примечание:**_ При работе с данными содержащими символы кириллицы также лучше всего указывать кодировку данных файла явно, выбрав из списка в графе **File encoding** соответствующее значение.
  * Нажать **Preview** и удостовериться, что файл был корректно прочитан. Полученные из файла данные должны отобразится в появившемся окне.
  * Нажать **OK** для завершения и принятия настроек для Шага **CSV file input**.

#### Конфигурация Шага JavaScript для модификации значения (Modified JavaScript Value) ####

  * Дважды нажать на Шаг **Modified JavaScript Value**.
  * Появиться окно настроек для этого Шага. Данное окно отличается от предыдущего возможностью написания исполняемого кода на языке JavaScript. Оно необходимо для создания фразы из двух частей, объединения части приветствия **"Здравствуй, "** с каждым из имён.
  * Назвать данный Шаг **Создание приветствия**.
  * Центральная область окна настроек предназначена для ввода кода. В левой панели представлен набор доступных для использования при написании кода функций. При этом внизу списка представлены две группы **Input fields** и **Output fields** готовые к использованию. Для данного примера потребуются два поля: **фамилия** и **имя**. Ввести код:
```
var message = 'Здравствуй, ' + имя.getString() + "!";
```
> _**Примечание:**_ Функцию **имя.getString()** можно ввести вручную или дважды нажать на поле в раскрывающемся списке функций.
  * В нижней части окна расположен список создаваемых в результате выполнения скрипта переменных. В данном примере создаётся переменная **message**. Так как значение данной переменной должно быть передано в файл с результатом Преобразования, наименование данной переменной следует указать в списке. Результат будет иметь следующий вид:
![![](http://farm3.static.flickr.com/2463/3767450235_2e276cd75a_m.jpg)](http://farm3.static.flickr.com/2463/3767450235_fbcafd06fc_o.png)

> (!) _**Внимание:**_ Не следует путать переменные внутри скрипта с переменными приложения PDI:Kettle, это не одно и тоже.

> _**Примечание:**_ Для совместимости выполнения скриптов в различных вариантах версий PDI:Kettle следует графу **Compatibility mode?** отметить галочкой.
  * Нажать **OK** для завершения и принятия настроек для Шага **Step Modified Script Value**.
  * Выбрать иконку только что отредактированного Шага. На данном Шаге происходит добавление нового поля к _Входящим Полям (Input Field)_ и передача их всех вместе в _Исходящие Поля (Output Field)_. _Входящие Поля_ поступают на данном Шаге. _Исходящие Поля_ покидают данный Шаг. Каждый шаг производит трансформацию значений поступивших данных. В данном примере, значения поступивших данных остались без изменений добавилось только одно Исходящее Поле. Но есть Шаги, которые добавляют значения к Входящим Полям, например **Calculator**. Также есть Шаги производящие фильтрацию и комбинирование поступающих данных, в результате _Исходящих Полей_ меньше чем _Входящих Полей_, например **Group by**.
  * Нажать правую клавишу мыши для доступа к контекстному меню.
  * Выбрать **Show Input Fields**. В появившемся окне можно увидеть Входящие Поля **фамилия** и **имя**, полученные на предыдущем Шаге.
  * Выбрать **Show Output Fields**. В появившемся окне видно, что поступившие поля остались без изменений, но добавилось одно новое поле **message**.

#### Конфигурация Шага Вывод в XML файл (XML Output) ####

  * Дважды нажать на Шаг **XML Output**. Откроется окно для данного вида Шага. На данном шаге определяется место расположения и название файла с результатом выполнения Преобразования. Также задаются Поля, которые необходимо поместить в данный файл. Для вывода могут быть заданы, как все Поля достигшие данного Шага, так и отдельные Поля по выбору.
  * На вкладке **File** задать название **Выгрузка списка приветствий** для данного Шага.
  * В графе **File** ввести:
```
${Internal.Transformation.Filename.Directory}/hello.xml
```
  * Перейти на вкладку **Fields** и нажать кнопку **Get Fields**, в списке полей появятся три поля для вывода. Для исходящего файла необходимо только поле **message**, поэтому необходимо удалить поля **имя** и **фамилия**.
![![](http://farm3.static.flickr.com/2554/3767450491_b99befd316_m.jpg)](http://farm3.static.flickr.com/2554/3767450491_55e3a83929_o.png) ![![](http://farm4.static.flickr.com/3421/3767450563_5bc7cdccc2_m.jpg)](http://farm4.static.flickr.com/3421/3767450563_cf3c882e4a_o.png)

  * Нажать **OK** для завершения и принятия настроек для Шага **XML Output**.
  * Сохранить Преобразование.

## Принципы работы ##

При выполнении Преобразования практически все Шаги выполняются одновременно.  Из-за того, что Преобразование запускает потоки асинхронно, скорость выполнения отдельных Шагов неодинакова. Каждая выполняемая строка потока передаётся на следующий Шаг не ожидая следующей строки данных. Необходимо не забывать эту особенность Преобразований, так как она может сильно повлиять на результат выполнения.

Настройка примера "Привет, Мир!" практически завершено. Преобразование считывает данные из входного файла; с помощью кода JavaScript создаются приветствия для каждого из рядов данных; в итоге полученное сообщение сохраняется в конечном файле. В данном небольшом примере всего несколько строк с именами, поэтому заметить асинхронное выполнение очень сложно. Однако надо иметь ввиду что, когда одна строка записывается в конечный файл, другая только покидает первый Шаг Преобразования.

## Проверка, просмотр и выполнение ##

  * Перед выполнением Преобразования, необходимо проверить правильность работы каждой из функций. Выбрать **Transformation** и нажать **Verify**. Spoon проверит синтаксис Преобразования, выявив недостижимые Шаги и несуществующие связи. Если Преобразование прошло проверку успешно (а это должно быть именно так, если следовать данной инструкции), оно готово для предварительного просмотра.
  * Выделить Шаг **Создание приветствия**, выбрать **Transformation** и затем нажать **Preview**. Должно появится окно вида:
![![](http://farm3.static.flickr.com/2552/3767450651_c2847d2c56_m.jpg)](http://farm3.static.flickr.com/2552/3767450651_2f50868064_o.png)
  * Spoon предлагает предварительно просмотреть результаты выполнения выбранного Шага. Нажать кнопку **QuickLaunch**. После чего появится окно с результатом полученным в результате выполнения Шага **Создание приветствия**. Если результат удовлетворяет предъявляемым требованиям, значит всё готов для выполнения Преобразования.
  * Выбрать **Transformation** и затем нажать **Run**.
  * Появится окно в котором можно задать параметры выполнения и отслеживания Преобразования. Нажать кнопку **Launch**.
  * В нижней части окна приложения появится окно с несколькими вкладками. Во вкладках содержится информация о выполнении текущего Преобразования.

На вкладке **Step Metrics** отображено выполнение операций Преобразования по Шагам. Необходимо обратить внимание на следующие колонки:
  * **Read**: количество строк полученных из предыдущего Шага.
  * **Written**: количество строк переданных с данного шага на следующий.
  * **Input**: число строк прочитанных из файла или таблицы базы данных.
  * **Output**: число строк записанных в файл или таблицу базы данных.
  * **Errors**: число ошибок возникших при выполнении. Если возникли ошибки вся строка отмечается красным.

На вкладке **Logging** отображён журнал выполнения. В нём содержится подробная информация о выполнении Преобразования по Шагам. Если детально разбирать журнал выполнения, то можно увидеть асинхронность выполнения Шагов. При успешном выполнении Преобразования в нижней строке журнала будет следующее сообщение:
```
Spoon - The transformation has finished!!
```
Также при успешном завершении Преобразования будет создан файл **hello.xml**, необходимо проверить его содержание на корректность выполнения поставленной задачи.

## Pan ##

Pan это модуль исполнения Преобразований из терминального окна. Его запуск производится через скрипт **pan.bat** в Windows или **pan.sh** на других платформах. Скрипт расположен в установочном каталоге. Если скрипт запускается без параметров на экран выводятся список доступных параметров для выполнения Pan.

Запустить Преобразование можно следующей командой:
```
Pan /file <Jobs_path>/hello.ktr /norep
```
  * `/norep` команда не включает подключение Spoon к репозитарию.
  * `/file` указывает на имя файла содержащего Преобразование.
  * `<Jobs_path>` полный путь к каталогу с примером: `C:/Pentaho/Tutorial` или `/home/PentahoUser/Tutorial`.
Остальные параметры запуска будут использованы по-умолчанию.

После запуска данной команды Преобразование выполняется точно также, как и при запуске через Spoon. В данном случае на экран или в файл (если его указать) будет выведен журнал выполнения. Формат журнала будет отличаться от того, что был представлен в графической оболочке, но его содержание будет аналогичным.

# Оптимизация примера "Здравствуй, Мир!" #

Теперь, когда Преобразование проверено в работе, его необходимо оптимизировать для выполнения возложенных задач.

## Описание ##

Вот что позволит оптимизировать работу Преобразования:
  * Сделать так, чтобы входящий файл мог располагаться не только в каталоге где хранится файл Преобразования. Имя файла также может изменятся, для чего необходимо передавать его в Преобразование как параметр при запуске.
  * Проверять наличие входящего файла.
  * Название исходящего файла должно зависеть от имени входящего.

Для этого следует использовать алгоритм:
  * Получить параметр.
  * Создать исходящий файл с приветствием.
  * Проверить что параметр равен **null**; если так, то прервать выполнение.
  * Проверить что файл существует; если не так, то прервать выполнение.

Реализовать данный алгоритм можно с помощью Spoon и схемы _Задание_, организовав Элементы Задания по средствам Переходов. Порядок и путь выполнения Элементов Задания и Переходов происходит согласно результатам выполнения каждого из Элементов. По этому можно говорить о Заданиях, как _ориентированных на контроль потоков_.

_Элементы Задания_ это составные единицы выполнения функций в рамках отдельного Задания. Каждый Элемент это отдельная законченная функция, диапазон выполняемых функций охватывает задачи от проверки наличия таблиц баз данных до отправки электронных сообщений. Внутри одного Задания есть возможность запускать Преобразования или другие Задания, они тоже будут Элементами Задания.

Переход это графическое представление для указания последовательности выполнения Элементов Задания. Если Переход имеет только один источник и только один приёмник, то Элементы Задания могут иметь любое количество исходящих и входящих Переходов.

Задача данного примера будет выполняться следующим образом:
  * Получение входного параметра будет реализовано с помощью **Преобразования (1)**. Оно будет составлено согласно представленной ниже диаграммы:

![http://farm3.static.flickr.com/2529/3789818944_f7c314e3af_o.png](http://farm3.static.flickr.com/2529/3789818944_f7c314e3af_o.png)

  * Проверка полученного параметра будет производится на основе результата выполнения **Преобразования (1)**. В зависимости от результата будет выбираться следующий Шаг.
  * Существование исходящего файла будет проверено специальным Элементом Задания.
  * Для выполнения основной функции Задания, создаваемого в рамках данного примера, необходимо изменить Преобразование разработанное в предыдущем примере "Здравствуй, Мир!".

Созданное Задание будет иметь следующий графический вид:

![http://farm4.static.flickr.com/3419/3789820454_96c406e3dc_o.png](http://farm4.static.flickr.com/3419/3789820454_96c406e3dc_o.png)

## Подготовка окружения ##

В данной части руководства входящий и исходящий файлы будут размещаться в специально созданном каталоге **Files**. Каталог необходимо создать и разместить в нём файл **list.csv**.

Чтобы каждый раз не приходилось указывать полный путь к каталогу с файлами, необходимо создать переменную содержащую его. Для этого следует изменить файл конфигурации **kettle.properties**, расположенный в `C:\Documents and Settings\<username>\.kettle` каталога Windows или `~/.kettle` каталога в других операционных системах. В конфигурационный файл добавляется строка, с указанием полного пути к содержанию каталога **Files**:
```
FILES=C:/Pentaho/Files
```
или
```
FILES=/home/PentahoUser/Files
```
Spoon загружает данные из этого файла при запуске, по этому следует выйти Spoon и запустить его снова.

Всё готово к началу работы над данной частью руководства. Задача будет состоять из:
  1. Создание Элемента Задания **Преобразование 1**.
  1. Изменение Элемента Задания **Преобразование 2**.
  1. Конструирование единого Задания из Элементов.

## Создание Элемента Преобразование 1 ##
  1. Создать Преобразование по аналогии с первым примером. Назвать Преобразование **get\_file\_name**.
  1. Переместить Шаги в рабочую область и соединить как показано на диаграмме:
    1. Get System Info (из категории Input)
    1. Filter Rows (из категории Flow)
    1. Abort (из категории Flow)
    1. Set Variable (из категории Job)
  1. Настроить Шаги.
  1. Запустить Преобразование get\_file\_name.
![http://farm3.static.flickr.com/2643/3789818580_95567284a6_o.png](http://farm3.static.flickr.com/2643/3789818580_95567284a6_o.png)

### Настройка Шагов ###
#### Настройка Шага Получение системной информации (Get System Info) ####
Данный Шаг предназначен для получения Преобразованием информации извне, например системной даты или параметров введённых в командную строку. В этом примере он необходим для получения параметра из командной строки. В окне настроек внизу расположены строки, их заполнение создаёт столбцы системных данных в исходящем потоке этого Шага.
  1. Дважды нажать на Шаг **Get System Info**.
  1. Назвать данный Шаг **Получить системную информацию**.
  1. В первой строке списка в столбце **Name** ввести имя получаемого значения **my\_file**.
  1. Далее нажать на столбец **Type**, раскроется список с доступными значениями. Выбрать **command line argument 1**.
  1. Нажать **OK** для завершения и принятия настроек для Шага **Get System Info**.
![![](http://farm3.static.flickr.com/2624/3789819144_227f61fb65_m.jpg)](http://farm3.static.flickr.com/2624/3789819144_38fb3fecd8_o.png)

#### Настройка Шага Фильтр строк (Filter Rows) ####
На данном Шаге происходит разделение одного единого потока данных на два, в соответствии с установленными условиями. Строки, значения которых совпадают с  условиями, отправляются в первом исходящем потоке, остальные строки, не удовлетворяющие условию, направляются во второй поток.
  1. Дважды нажать на Шаг **Filter Rows**.
  1. Назвать данный Шаг **Фильтровать строки**.
  1. Установить условие: в графе **field** выбрать **my\_file** и заменить **=** на **IS NOT NULL**.
  1. В раскрывающемся списке **Send 'true' data to Step** выбрать Шаг **Set Variable**.
  1. В раскрывающемся списке **Send 'false' data to Step** выбрать Шаг **Abort**.
  1. Нажать **OK** для завершения и принятия настроек для Шага **Filter Rows**.
Теперь если значение параметра не равно _NULL_ поток передаётся на Шаг **Назначить переменную**, в обратном случае на Шаг **Прервать преобразование**.

![![](http://farm4.static.flickr.com/3480/3789008173_4537d7f70d_m.jpg)](http://farm4.static.flickr.com/3480/3789008173_bfe99e458b_o.png)

#### Настройка Шага Прерывания (Abort Step) ####
  1. Дважды нажать на Шаг **Abort Step**.
  1. Назвать данный Шаг **Прервать преобразование**.
  1. Больше ничего не требуется настраивать в этом Шаге. Если данные переданы на этот Шаг, Преобразование прерывается и отрицательный результат выполнения передаётся в основное Задание. Нажать **OK** для завершения и принятия настроек для Шага **Abort Step**.
![![](http://farm4.static.flickr.com/3478/3789819398_460f6b455f_m.jpg)](http://farm4.static.flickr.com/3480/3789008173_bfe99e458b_o.png)

#### Настройка Шага Назначение переменной (Set Variable) ####
Данный Шаг предназначен для создания переменных из Входящих Полей. В нижней части окна настроек расположен список создаваемых переменных. Каждая графа резервируется для одной переменной.
  1. Дважды нажать на Шаг **Set Variable**.
  1. Назвать данный Шаг **Назначить переменную**.
  1. Нажать внизу кнопку **Get Fields**, единственным доступным Входящим Полем будет **my\_file**. Назначить для него имя переменной **Variable name**, тоже наименование, но только в верхнем регистре **MY\_FILE**.
  1. Указать для переменной область действия, в данном примере это JVM. В графе **Variable scope type** выбрать **Valid in the Java Virtual Machine**.
  1. Нажать **OK** для завершения и принятия настроек для Шага **Set Variable**.
![![](http://farm4.static.flickr.com/3548/3789008703_212313304c_m.jpg)](http://farm4.static.flickr.com/3548/3789008703_8b98dc56cd_o.png)

### Проверка выполнения ###
Для проверки работы полученного Преобразования выбрать **Transformation** и нажать **Run**.
  1. В появившемся окне есть раздел **Parameters**. В нём в виде списка заносятся параметры передающиеся в Приложения из командной строки. В первой строке в столбце **Value** ввести **list**.
  1. Нажать кнопку **Launch**.
  1. В окне журнала необходимо найти следующую строку:
```
Назначить переменную.0 - Set variable MY_FILE to value [list]
```
Это означает, что в результате выполнения Преобразования была присвоено значение переменной **MY\_FILE**.
  1. Повторить запуск Преобразования, но при этом не указывать значение в разделе **Parameters**. Теперь следует отыскать в журнале строки:
```
Прервать преобразование.0 - Row nr 1 causing abort : []
Прервать преобразование.0 - Aborting after having seen 1 rows.
```
Данный вариант выполнения означает, что параметр не был получен и Преобразование выполнено с ошибкой.

![![](http://farm4.static.flickr.com/3486/3789820080_08a79052ee_m.jpg)](http://farm4.static.flickr.com/3486/3789820080_3f9056c496_o.png)

## Изменение Элемента Преобразование 2 ##
Теперь необходимо добавить в Преобразование **hello** возможность получения параметров для определения имён файлов. Если параметр будет **foo**, то данные будут получены из файла **foo.csv** и записаны в файл **foo\_with\_greetings.xml**. Также будет добавлен фильтр для исключения пустых строк получаемых из входящего файла.
![http://farm3.static.flickr.com/2438/3789009251_ecb69b5ce0_o.png](http://farm3.static.flickr.com/2438/3789009251_ecb69b5ce0_o.png)

### Внедрение переменных ###
  1. Открыть Преобразование **hello.ktr**.
  1. Открыть окно настроек для Шага **Получение имён**.
  1. Удалить содержимое графы **Filename** и нажать **Ctrl-Пробел**, появится список доступных переменных. В списке присутствует переменная **FILES** добавленная в **kettle.properties**. Выбрать её и добавить к ней имя переменной полученной в предыдущем Преобразовании **get\_file\_name**. Текст будет иметь вид:
```
${FILES}/${MY_FILE}.csv
```
  1. Нажать **OK**.
  1. Открыть окно настроек для Шага **Выгрузка списка приветствий**.
  1. Заменить содержимое графы **Filename** на:
```
${FILES}/${MY_FILE}_with_greetings.xml
```
  1. Нажать **OK**.

### Фильтрация строк ###
  1. Перетащить Шаг **Filter Rows** на линию Перехода между Шагами **Получение имён** и **Создание приветствия** (когда линия Перехода изменит свой вид, необходимо отпустить клавишу мыши). Теперь следует одобрить разделения данного перехода новым Шагом.
  1. Дважды нажать на Шаг **Filter Rows**.
  1. Назвать данный Шаг **Фильтрация пустых строк**.
  1. В графе **field** выбрать поле **name** и назначить условия для выборки **IS NOT NULL**.
  1. Оставить графы **Send 'true' data to Step** и **Send 'false' data to Step** незаполненными. В результате работы фильтра в исходящем потоке остаются только строки удовлетворяющие условию (строки с заполненными именами).
  1. Нажать кнопку **OK**.
  1. Нажать **File** и выбрать **Save As**, сохранить это Преобразование под именем **hello\_with\_parameters**.

### Запуск ###
Для проверки произведённых изменений необходимо задать значение переменной **MY\_FILE**. Так как данная переменная создаётся не внутри данного Преобразования, необходимо её задать вручную.
  1. Перейти в меню **Edit**, выбрать **Set Environment Variables**. Откроется окно со списком переменных.
  1. В нижней части списка расположена переменная **MY\_FILE**, в столбце **Value** набрать имя файла без расширения.
  1. Нажать кнопку **OK**.
  1. Перейти в меню **Transformation** и выбрать **Run**.
  1. В разделе **Variables** должны быть созданные переменные. Нажать кнопку **Launch** для запуска Преобразования.
  1. Проверьте наименование и содержание получившегося файла.

## Конструирование основного Задания ##
Теперь требуется разработать структуру основного Задания.
  1. Создать Задание:
    1. Перейти в меню **New**, выбрать **Job**.
    1. Рабочая область предназначена для размещения Элементов Задания и Переходов между ними.
    1. Перейти в меню **Job**, выбрать **Settings...**.
    1. В открывшемся окне задаются основные свойства Задания. Заполнить графы имя **Job name** и описание **Description**. Нажать кнопку **OK**.
    1. Перейти в меню **File**, выбрать **Save**. Сохранить Задание в каталоге **Tutorial** под именем **hello**.
  1. Построить каркас Задания из Элементов и Переходов. Список доступных Заданий расположен слева от рабочей области. Все Элементы Заданий, как и Шаги Преобразований упорядочены по категориям.

Начнём конструировать Задание:
  1. Переместим в рабочую область по одному Элементу Задания **Start** и **Success** из категории **General**, два Элемента **Transformation** из категории **General** и один Элемент **File Exists** из категории **Conditions**, назовём их и соединим Переходами.
  1. Переместим два Элемента **Abort** в рабочую область, назовём их и соединим Переходами. Стрелки Переходов должны быть красного цвета.
  1. Настройка Шага **Преобразование 1**:
    1. Дважды нажать на **Преобразование (1)**. Откроется окно настроек.
    1. В графе **Transformation filename** указать имя файла Преобразования **get\_file\_name.ktr**.
    1. Так как Преобразования и Задания находятся в одном каталоге следует добавить следующий путь к каталогу:
```
${Internal.Job.Filename.Directory}/get_file_name.ktr
```
    1. Нажать кнопку **OK**.
  1. Настройка Шага **Преобразование 2**:
    1. Дважды нажать на **Преобразование (2)**. Откроется окно настроек.
    1. Ввести имя файла для данного преобразования в графе **Transformation Filename**:
```
${Internal.Job.Filename.Directory}/hello_with_parameter.ktr
```
    1. Нажать кнопку **OK**.
  1. Настройка Шага **Наличие файла**:
    1. Дважды нажать на **Преобразование (2)**. Откроется окно настроек.
    1. Поместить в графу **Filename** путь к файлу наличие которого необходимо проверить. Это имя входящего файла в **Преобразование 2**:
```
${FILES}/${MY_FILE}.csv
```
> > _**Примечание:**_ Напомним переменная **$\{FILES}** была определена в файле **kettle.properties**, а переменная **$\{MY\_FILE}** создана в результате выполнения Элемента **Преобразование (1)**.
  1. Настройка Шага **Прерывание работ (1)**:
    1. Задать служебное Сообщение в графе **Message**.
```
Имя файла не заданно.
```
  1. Настройка Шага **Прерывание работ (2)**:
    1. Задать служебное Сообщение в графе **Message**.
```
Файл ${FILES}/${MY_FILE}.csv отсутствует.
```
> > _**Примечание:**_ При выполнении имена переменных будут заменены на фактические значения. Например:
```
Файл С:/Pentaho/Files/list.csv отсутствует.
```

## Настройка Переходов ##
Последовательность выполнения Элементов Задания, может зависеть или не зависеть  от результата выполнения Элемента источника Перехода. Путь по которому осуществляется Переход выделяется цветом:
  * **чёрным цветом**, выделяется Переход, который не зависит от результата выполнения Элемента источника;
  * **зелёным цветом**, выделяется Переход, если результат выполнения Элемента источника положительный (без ошибки);
  * **красным цветом**, выделяется Переход, если результат выполнения Элемента источника отрицательный (с ошибокой).

Следует правильно назначить типы Переходов для успешного выполнения создаваемого Задания:
  * **Преобразование (1)** является первым выполняемым в данном Задании (переход из Шага **Start** чёрного цвета).
  * Если Элемент **Преобразование (1)** не найдёт параметр (т.е. Преобразование выполнено с ошибкой), то контроль (согласно красной стрелке Перехода) передаётся на Элемент **Прерывание работ (1)**.
  * Если Элементом **Преобразование (1)** будет получен параметр (т.е. Преобразование выполнено успешно), то контроль (согласно зелёной стрелке Перехода) передаётся на Элемент **Наличие файла**.
  * Если файл найден не будет (проверка Элементом **Наличие файла** выполнена неудачно), то контроль (согласно красной стрелке Перехода) передаётся на Элемент **Прерывание работ (2)**.
  * Если проверка Элементом **Наличие файла** будет успешно выполнена, контроль (согласно зелёной стрелке Перехода) будет передан на Элемент **Преобразование (2)**.
  * Общий результат успешного выполнения Задания (указан Элементом **Выполнение работ**) не будет зависеть от результатов выполнения Элемента **Преобразование (2)**.

Для выбора типа условия, необходимо сделать следующее:
  1. Навести курсор на стрелку Перехода между двумя Элементами.
  1. Нажать правую клавишу мыши, появится контекстное меню.
  1. Выбрать раздел **Evaluation**, и указать одно из доступных условий.

## Принципы выполнения ##

Выполнение Задания напрямую зависит от последовательности выполнения Элементов и руководствуется условиями Переходов. Выполнение происходит последовательно. Выполнение очередного Элемента Задания невозможно пока все предшествующие Задания не будут окончены.

Для реальных задач Задание может служить хорошим инструментом для решения проблем связанных с последовательностью выполнения Преобразований. Так, если необходимо чтобы часть Преобразования была выполнена прежде чем начнётся следующая, одно Преобразование разделяется на два независимых Преобразования, которые последовательно выполняются в рамках одного Задания.

## Проверка выполнения Задания ##

Для проверки выполнения созданного Задания необходимо перейти в меню **Transformation** и нажать **Run**.
  1. В появившемся окне в разделе  **Arguments** в первой строке в графе **Value** задать значение **list** (имя исходящего файла без расширения).
  1. Нажать кнопку **Launch**.
  1. Под рабочей областью откроются вкладки содержащие отчёты о выполнении Задания.

На вкладке **Job metrics** последовательно представлено выполнение каждого из Элементов. В нём отображены только те Элементы, которые фактически были выполнены, если Элемент не был запущен, то его на вкладке нет.

На вкладке **Logging** содержится журнал выполнения Задания. В нём отображена детальная информация о выполнении каждого Элемента Задания, в том числе время начала и окончания выполнения. Также, если при выполнении Задания было запущено Преобразование, его журнал будет включён в данный журнал. Если для данного примера был создан новый файл, то в последней строке журнала содержится строка:
```
Spoon - Job has ended.
```
Также если входящий файл был **list.csv**, то созданный исходящий файл должен называться **list\_with\_greetings.xml** и располагаться в указанном каталоге. Необходимо найти и проверить его.

Теперь введём в качестве параметра имя несуществующего файла и запустим Задание повторно. Выполнение Задания будет прервано и в журнале будет следующие сообщение (где `<path_and_file>` это имя файла и путь к нему):
```
Прерывание работ (2) - ERROR : Файл <path_and_file> отсутствует.
```

Теперь вообще удалим параметры и запустим Задание. В данном случае Задание также будет прервана и в журнале будет запись:
```
Прерывание работ (1) - ERROR : Имя файла не задано.
```

## Kitchen ##

Kitchen это средство для запуска Заданий из окна терминала. Скрипт **kitchen.bat** для Windows и **kitchen.sh** для остальных операционных систем расположены в каталоге приложения. Если его запустить, то будет выведен список доступных для него ключевых команд с описанием.

Запустить выполнение Задания можно простейшей командой:
```
kitchen /file <Jobs_path>/Hello.kjb <par> /norep
```
  * `/norep` команда не включает подключение Spoon к репозитарию.
  * `/file` указывает на имя файла содержащего Задание.
  * `<Jobs_path>` полный путь к каталогу с примером, `С:/Pentaho/Tutorial` или `/home/PentahoUser/Tutorial`.
  * `<par>` это тот параметр, который необходимо получить из внешней среды для успешного выполнения Задания. Это будет имя файла без расширения **csv**.
  * Могут быть добавлены и другие ключевые параметры такие как детализация журнала, но в данном случае они используются по-умолчанию.

После запуска команды, Задание будет выполнено аналогично как в Spoon. Но в данном случае журнал выполнения будет выведен в окне терминала, если не будет перенаправлен в текстовой файл. Формат журнала несильно отличается от того, что представлен в графической оболочке Spoon.

Дальше попробуйте запустить Задание без параметра или с неправильным параметром (файл с таким именем отсутствует) и проверьте результат выполнения. Также поэкспериментируйте с Kitchen изменяя варианты представления журналов выполнения.