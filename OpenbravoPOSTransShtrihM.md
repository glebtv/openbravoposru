# Введение #
С выходом версии [Openbravo POS 2.30](http://wiki.openbravo.com/wiki/Openbravo_POS_2.30_Release_notes/ru) было предложено в качестве средств выгрузки/загрузки данных использовать инструментарий [PDI:Kettle](http://kettle.pentaho.org/). Начиная с этой версии в пакет Openbravo POS входят задания и преобразования необходимые для проведения синхронизации справочников и сведений о реализации между Openbravo ERP и POS. Данный пример послужил основанием для начала работ по созданию аналогичного механизма для обмена данными между система работающими на основе протокола обмена для систем автоматизации [ШТРИХ-М](http://shtrih-m.ru/).

# Описание #
Протокол Штрих-М основан на принципе обмена текстовыми файлами подготовленными соответствующим образом. Описание протокола представлено в руководстве администратора [ШТРИХ-М: РМК 6.0](http://www.shtrih-m.ru/production/produce_711.html). Для целей разработки выбран автоматический режим обмена. Для проведения обмена данными был разработаны пакеты:
  * пакет загрузки в базу данных (БД) Openbravo POS из файла Штрих-М (cкачать [transformations-ShtrihM-IN\_PRODUCTS\_JOB.zip](http://openbravoposru.googlecode.com/files/transformations-ShtrihM-IN_PRODUCTS_JOB.zip));
  * пакет выгрузки из БД Openbravo POS в файл Штрих-М (скачать [transformations-ShtrihM-OUT\_PRODUCTS\_JOB.zip](http://openbravoposru.googlecode.com/files/transformations-ShtrihM-OUT_PRODUCTS_JOB.zip)).

# Структура #
Так как обмен между системы будет производится с помощью файлов заданий и преобразований, и через текстовые файлы, предполагается использовать следующую структуру расположения каталогов и файлов:
```
   ./IN					<- каталог где хранятся загружаемые файлы
   ./OUT				<- каталог где хранятся выгружаемые файлы
   IN PRODUCTS JOB.kjb			<- основное задание для загрузки файла-справочника
   Check ARG.ktr			<- преобразование для проверки наличия параметров при запуске
   IN CHECK SPR AND FLZ FILES.kjb	<- задания для проверки загружаемого файла-справочника и файла-флага
   IN Check SPR.ktr			<- преобразование для проверки структуры загружаемого файла-справочника
   IN Get CMD.ktr			<- преобразование для получения специальных команд из файла-справочника
   IN Product Categories.ktr		<- преобразование для загрузки категорий товара
   IN Warehouse.ktr			<- преобразование для загрузки складов
   IN TAXES JOB.kjb			<- задание для загрузки видов налогов и налоговых групп
   IN Tax Categories.ktr		<- преобразование для загрузки налоговых групп
   IN Taxes.ktr				<- преобразование для загрузки видов налогов
   IN Products.ktr			<- преобразование для загрузки номенклатуры товаров
   OUT PRODUCTS JOB.kjb			<- основное задание для выгрузки файла-справочника
   OUT Create SPR.ktr			<- преобразование для создания файла для выгрузки
   OUT Product Categories.ktr		<- преобразование для выгрузки категорий товара
   OUT Products.ktr			<- преобразование для выгрузки номенклатуры товара
   OUT TAXES JOB.kjb			<- задание для выгрузки видов налогов и налоговых групп
   OUT Tax Categories.ktr		<- преобразование для выгрузки налоговых групп
   OUT Taxes.ktr			<- преобразование для выгрузки видов налогов
   OUT Set CMD.ktr			<- преобразование для установки служебной команды
```

Подробнее о разработке заданий и преобразований [здесь](http://code.google.com/p/openbravoposru/wiki/PDIKettleTutorial).

# Загрузка информации в справочники #
  1. Подготовить файл для загрузки в Openbravo POS. Значение `Имя_файла` должно соответствовать коду склада `LOCATIONS.ID` в БД Openbravo POS, если данный склад не существует в БД Openbravo POS, то при выполнении загрузки он будет создан.
  1. Сохранить файл для загрузки в каталоге `./IN`. При сохранении системой ` ` должен быть создан файл-флаг вида `Имя_файла.FLZ`.
  1. Запустить на выполнение `IN PRODUCTS JOB.kjb`.
  1. Если загрузка прошла успешна, то в таблицы БД Openbravo POS будут загружены данный из файла `Имя_файла.SPR` и файл-флаг `Имя_файла.FLZ` будет удалён.

![http://farm3.static.flickr.com/2555/4029114234_62054b510f_o.png](http://farm3.static.flickr.com/2555/4029114234_62054b510f_o.png)

## Трансформация полей данных Штрих-М для загрузки в таблицы БД Openbravo POS ##

### Справочник категорий по товарам в таблицу CATEGORIES ###
Загрузка данных в БД производится в преобразовании **IN Product Categories**. Из загружаемого файла выбираются строки начинающиеся на цифры от `0` до `9`, буквы от `A` до `Z` или `пробел`.
| **Назначение**			| **Штрих-М**	 | **Openbravo POS**	| **Описание**				    |
|:-----------------|:-------------|:------------------|:--------------------|
| Код категории		  | `Поле_1`	    | `CATEGORIES.ID`	  | назначается если `Поле_17` равно _1_ |
| Название категории		| `Поле_3`     | `CATEGORIES.NAME` | 					               |
| Родительская категория	| `Поле_16`    | `CATEGORIES.PARENTID` |			 	                |

### Справочник категорий по товарам в таблицу LOCATIONS ###
Загрузка данных в БД производится в преобразовании **IN Warehouse**. Значение `Имя_файла` соответствует имени загружаемого файла.
| **Назначение**			| **Штрих-М**	   | **Openbravo POS**	| **Описание**				|
|:-----------------|:---------------|:------------------|:----------------|
| Код склада			    | `Имя_файла`    | `LOCATIONS.ID`    | код склада назначается в зависимости от имени загружаемого файла-справочника |
| Название склада		| `Имя_файла`    | `LOCATIONS.NAME`  | значение устанавливается только при создании записи |

### Справочник налоговых групп в таблицу TAXCATEGORIES ###
Загрузка данных в БД производится в преобразовании **IN Tax Categories**. Из загружаемого файла выбираются строки начинающиеся на `*`.
| **Назначение**			| **Штрих-М**	 | **Openbravo POS**	| **Описание**				|
|:-----------------|:-------------|:------------------|:----------------|
| Код налоговой группы		| `*Поле_1`    | `TAXCATEGORIES.ID`| 					           |
| Название налоговой группы	| `*Поле_2`    | `TAXCATEGORIES.NAME`| 					           |

### Справочник видов налогов в таблицу TAXES ###
Загрузка данных в БД производится в преобразовании **IN Taxes**. Из загружаемого файла выбираются строки начинающиеся на `+` и `*`.
| **Назначение**			| **Штрих-М**	| **Openbravo POS**	| **Описание**				|
|:-----------------|:------------|:------------------|:----------------|
| Код налога			    | `*Поле_1` + `*Поле_3` + `*Поле_4` | `TAXES.ID`        |		               |
| Название налога		| `+Поле_2` + `*Поле_1` + `*Поле_4` | `TAXES.NAME`      |		               |
| Налоговая группа		| `*Поле_1`   | `TAXES.CATEGORY`  | 					           |
| Ставка налога		  | `+Поле_4`   | `TAXES.RATE`  	   | 					           |

### Справочник товаров в таблицу PRODUCTS ###
Загрузка данных в БД производится в преобразовании **IN Products**. Из загружаемого файла выбираются строки начинающиеся на цифры от `0` до `9`, буквы от `A` до `Z` или `пробел`.
| **Назначение**			| **Штрих-М**	| **Openbravo POS**	| **Описание**					|
|:-----------------|:------------|:------------------|:-----------------|
| Код товара			    | `Поле_1`	   | `PRODUCTS.ID`	    |  назначается если `Поле_17` равно _0_	|
| -//-				         | `Поле_1`	   | `PRODUCTS.REFERENCE` | 						           |
| Штрих-код			     | `Поле_2` + `Поле_1`	| `PRODUCTS.CODE`   |				              |
| Название товара		| `Поле_3`	   | `PRODUCTS.NAME`	  | 						           |
| Цена продажи			  | `Поле_5`	   | `PRODUCTS.PRICESELL` |						            |
| Налоговая группа		| `Поле_11`   | `PRODUCTS.TAXCAT` | 						           |
| Весовой товар		  | `Поле_8`	   | `PRODUCTS.ISSCALE` | 						           |
| Категория товара		| `Поле_16`   | `PRODUCTS.CATEGORY` | 						           |

### Список доступных номенклатурных позиций в таблицу PRODUCTS\_CAT ###
Загрузка данных в БД производится в преобразовании **IN Products**. Из загружаемого файла выбираются строки начинающиеся на цифры от `0` до `9`, буквы от `A` до `Z` или `пробел`.
| **Назначение**			| **Штрих-М**	| **Openbravo POS**	| **Описание**	|
|:-----------------|:------------|:------------------|:-------------|
| Доступная позиция		| `Поле_1`	   | `PRODUCTS_CAT.PRODUCT` | 	            |

### Количественные остатки по товарам в таблицу STOCKCURRENT ###
Загрузка данных в БД производится в преобразовании **IN Products**. Из загружаемого файла выбираются строки начинающиеся на цифры от `0` до `9`, буквы от `A` до `Z` или `пробел`.
| **Назначение**			| **Штрих-М**	   | **Openbravo POS**		| **Описание**	|
|:-----------------|:---------------|:-------------------|:-------------|
| Код склада			    | `Имя_файла`    | `STOCKCURRENT.LOCATION` | код склада назначается в зависимости от имени загружаемого файла-справочника |
| Код товара			    | `Поле_1`       | `STOCKCURRENT.PRODUCT` | 		           |
| Остаток товаров		| `Поле_6`	      | `STOCKCURRENT.UNITS`	| 		           |

Подробнее о структуре БД Openbravo POS 2.30 можно узнать [здесь](http://wiki.openbravo.com/wiki/POS/2.30/Database_Model).

# Выгрузка информации из справочников #
  1. Запустить на выполнение `OUT PRODUCTS JOB.kjb`. При запуске в параметрах обязательно следует указать код склада `LOCATIONS.ID` остатки по которому будут выгружаться.
  1. Если выгрузка прошла успешна, то в каталоге `./OUT` будут создан файл `Имя_файла.SPR`, содержащий информацию о товаре, и файл-флаг `Имя_файла.FLZ`, обозначающий успешную выгрузку.

![http://farm3.static.flickr.com/2775/4037063376_e7f740811a_o.png](http://farm3.static.flickr.com/2775/4037063376_e7f740811a_o.png)

## Трансформация полей данных из Openbravo POS для выгрузки в файл Штрих-М ##
### Сведения по группам товаров из таблицы CATEGORIES ###
Выгрузка данных из БД производится в преобразовании **Product Categories**. Признаком группы является занесение в `Поле_17` значения `0`.
| **Назначение**			| **Openbravo POS**	   | **Штрих-М**		 | **Описание**	|
|:-----------------|:---------------------|:--------------|:-------------|
| Код группы			    | `CATEGORIES.ID`	     | `Поле_1`	     |		            |
| Название группы		| `CATEGORIES.NAME`    | `Поле_3`	     |		            |
| Код родительской группы	| `CATEGORIES.PARENTID`| `Поле_16`	    |		            |
| Признак			       | `0`		                | `Поле_17`	    |		            |

### Сведения по товаров из таблицы PRODUCTS и STOCKCURRENT ###
Выгрузка данных из БД производится в преобразовании **OUT Products**. Признаком товарной позиции является занесения в `Поле_17` значения `1`. При выборке остатков товара по склада в качестве значения кода склада `STOCK.LOCATION` берётся значение `Имя_файла`.
| **Назначение**			| **Openbravo POS**	   | **Штрих-М**		 | **Описание**	|
|:-----------------|:---------------------|:--------------|:-------------|
| Код товара			    | `PRODUCTS.REFERENCE` | `Поле_1`	     |		            |
| Штрих-код			     | `PRODUCTS.CODE`	     | `Поле_2`	     |		            |
| Наименование товара для чека	| `PRODUCTS.NAME`	     | `Поле_3`	     |		            |
| Текст для чека		 | `PRODUCTS.NAME`	     | `Поле_4`	     |		            |
| Цена реализации товара	| `PRODUCTS.PRICESELL` | `Поле_5`	     |		            |
| Остаток товара на складе	| `STOCK.UNITS`	       | `Поле_6`	     |		            |
| Контроль дробного количества	| `PRODUCTS.ISSCALE`   | `Поле_8`	     |		            |
| Код налоговой схемы		| `PRODUCTS.TAXCAT`    | `Поле_11`	    |		            |
| Код родительской группы	| `PRODUCTS.CATEGORY`  | `Поле_16`	    |		            |
| Признак			       | `1`		                | `Поле_17`	    |		            |

### Сведения по налоговым схемам из таблицы TAXCATEGORIES ###
Выгрузка данных из БД производится в преобразовании **OUT Tax Categories**. Для выделения строки с налоговой схемой необходимо в начале строки добавить символ `*`.
| **Назначение**			| **Openbravo POS**	   | **Штрих-М**		 | **Описание**	|
|:-----------------|:---------------------|:--------------|:-------------|
| Код налоговой схемы		| `TAXCATEGORIES.ID`   | `Поле_1` 	    |		            |
| Наименование налоговой схемы	| `TAXCATEGORIES.NAME` | `Поле_2`	     |		            |
| Номер налога			  | `TAXES.ID`	          | `Поле_4` 	    |		            |

### Сведения по налогах из таблицы TAXES ###
Выгрузка данных из БД производится в преобразовании **OUT Taxes**. Для выделения строки с налоговой схемой необходимо в начале строки добавить символ `*`.
| **Назначение**			| **Openbravo POS**	   | **Штрих-М**		 | **Описание**	|
|:-----------------|:---------------------|:--------------|:-------------|
| Код налога			    | `TAXES.ID`	          | `Поле_1` 	    |		            |
| Название налога		| `TAXES.NAME`	        | `Поле_2`	     |		            |
| Текст для чека		 | `TAXES.NAME`	        | `Поле_3` 	    |		            |
| Процентная ставка налога	| `TAXES.RATE`	        | `Поле_4` 	    |		            |

Подробнее ознакомится с протоколом Штрих-М можно [здесь](http://support.shtrih-m.ru/data/soft/RMK6/shtrih-m_rmk6_admin_guide.rar).

# Настройка PDI:Kettle #
Для выполнения преобразований необходимо задать параметры подключения к БД Openbravo POS. Для этого следует внести следующие переменные в файл `kettle.properties` и присвоить им соответствующие значения:
```
db.URL = jdbc:mysql://localhost:3306/openbravopossync?useUnicode=true&characterEncoding=utf8
db.driver = com.mysql.jdbc.Driver
db.user = openbravo
db.password = openbravo
```
  * `db.URL` - адрес базы данных для подключения по JDBC;
  * `db.driver` - тип драйвера JDBC для подключения к базе данных;
  * `db.user` - имя пользователя для подключения к базе данных;
  * `db.password` - пароль пользователя для подключения к базе данных;

![http://farm3.static.flickr.com/2478/4029163855_7cafb8303c_o.png](http://farm3.static.flickr.com/2478/4029163855_7cafb8303c_o.png)

Подробнее о настройке [здесь](http://wiki.openbravo.com/wiki/Openbravo_POS_Integration#Configure_Pentaho_Data_Integration).

# Выполнение синхронизации #
Для того, чтобы установить выполнение синхронизации по расписанию, необходимо изменить элемент **Start** задания **IN PRODUCTS JOB**.
  * Отметить поле **Repeat** для постоянного выполнения.
  * Выбрать _Daily_ из списка поля **Type** для ежедневного выполнения.
  * Указать время выполнения в поле **Time of day**.

![http://farm3.static.flickr.com/2729/4029163981_7fb79a3890_o.png](http://farm3.static.flickr.com/2729/4029163981_7fb79a3890_o.png)

Для запуска задания **IN PRODUCTS JOB** из командной строки введите для Windows систем:
```
bat Kitchen.bat /file:"путь_к_каталогу/IN PRODUCTS JOB.kjb" /level:Basic
```
Для запуска из Linux и прочих Unix-подобных систем:
```
sh kitchen.sh -file="путь_к_каталогу/IN PRODUCTS JOB.kjb" -level=Minimal
```

После запуска, задание будет ожидать назначенного часа каждый день для начала выполнения. После успешного(элемент **Finish**) выполнения задание перейдёт в режим ожидания(состояние **Sleeping**) последующего момента запуск.

Подробнее о выполнении [здесь](http://wiki.openbravo.com/wiki/Openbravo_POS_Integration#Execute_Pentaho_Data_Integration).
